<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <title>Push to Prod</title>
  <script src="//cdn.jsdelivr.net/npm/phaser@3.11.0/dist/phaser.js"></script>

  <script src="https://code.jquery.com/jquery-3.5.1.min.js"
    integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>

  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css"
    integrity="sha384-JcKb8q3iqJ61gNV9KGb8thSsNjpSL0n8PARn9HuZOnIxN0hoP+VmmDGMN5t9UJ0Z" crossorigin="anonymous" />
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"
    integrity="sha384-B4gt1jrGC7Jh4AgTPSdUtOBvfO8shuf57BaghqFfPlYxofvL8/KUEfYiJOMMV+rV"
    crossorigin="anonymous"></script>

  <style type="text/css">
    body {
      margin: 0;
      background-color: greenyellow;
    }
  </style>
</head>

<body>
  <!-- Page Layout -->

  <div class="row mt-3 mb-3">
    <div class="col text-center">
      <h1>Push to Prod</h1>
      <h5>
        Squash all the bugs reported by your client in order to finally launch
        their site! <br />
        Be careful though, the client may have their developers introduce some
        new bugs before you're through.
        <br />
        Watch out for the "Bad Test Data" power up that will help you clear
        out some bugs quickly!
      </h5>
    </div>
  </div>
  <div class="row">
    <div class="col"></div>
    <div class="col">
      <canvas></canvas>
    </div>
    <div class="col"></div>
  </div>

  <!-- Game Script -->
  <script type="text/javascript">
    var config = {
      type: Phaser.AUTO,
      width: 800,
      height: 600,
      physics: {
        default: "arcade",
        arcade: {
          gravity: { y: 300 },
          debug: false,
        },
      },
      scene: {
        preload: preload,
        create: create,
        update: update,
      },
      canvas: document.querySelector("canvas"),
    };

    var player;
    var bugs;
    var platforms;
    var cursors;
    var bombs;
    var bugCount = 12;
    var bugText;
    var endRoundOne;
    var endRoundTwo;
    var round = 1;
    var roundText;
    var cameras = this.cameras;
    var launched = false;
    var facingRight = true;
    var countDown = 10;
    var gameTimer = 180;
    var timedEvent;
    var gameTimerEvent;
    var roundComplete = false;
    var hackers;
    var platformBarriers;
    var lastBombRelease = 180;
    var bombCount = 0;
    var firewallPowerups;
    var firewallUp = false;
    var allowBombs = false;
    var rocketCollider;
    var preLaunchComplete = false;

    var game = new Phaser.Game(config);

    function preload() {
      this.load.image("background", "assets/matrix.png");
      // this.load.image(
      //   "background_conflict",
      //   "assets/matrix_merge_conflict.png"
      // );
      this.load.image("rocket", "assets/rocket_small.png");
      this.load.image("rocket_platform", "assets/rocket_platform.png");
      this.load.image("ground", "assets/platform.png");
      this.load.image("bug", "assets/bug.png");
      this.load.image("bomb", "assets/bomb_new.png");
      this.load.image("door", "assets/door.png");
      this.load.image("firewallPowerup", "assets/firewall.png");
      this.load.image("switch_red", "assets/switch_red.png");
      this.load.image("switch_green", "assets/switch_green.png");
      this.load.image("barrier", "assets/platform_barrier.png");
      this.load.spritesheet("dude", "assets/predator.png", {
        frameWidth: 32,
        frameHeight: 48,
      });
      this.load.spritesheet("bomb_sprite", "assets/bomb_sprite.png", {
        frameWidth: 15,
        frameHeight: 15,
      });
      this.load.spritesheet("hacker_right", "assets/hacker_right.png", {
        frameWidth: 35,
        frameHeight: 48,
      });
      this.load.spritesheet("hacker_left", "assets/hacker_left.png", {
        frameWidth: 35,
        frameHeight: 48,
      });
      this.load.spritesheet("flame", "assets/flame_up.png", {
        frameWidth: 35,
        frameHeight: 48,
      });
      this.load.spritesheet("jepack_dude", "assets/jetpack_run_long.png", {
        frameWidth: 32,
        frameHeight: 48,
      });
      this.load.spritesheet("jump_right", "assets/jump_right.png", {
        frameWidth: 32,
        frameHeight: 48,
      });
      this.load.spritesheet("jump_left", "assets/jump_left.png", {
        frameWidth: 32,
        frameHeight: 48,
      });
      this.load.spritesheet("turn_right", "assets/turn_right.png", {
        frameWidth: 32,
        frameHeight: 48,
      });
      this.load.spritesheet("turn_left", "assets/turn_left.png", {
        frameWidth: 32,
        frameHeight: 48,
      });
      this.load.spritesheet("portal", "assets/portal.png", {
        frameWidth: 50,
        frameHeight: 60,
      });
    }

    function create() {
      this.add.image(400, 300, "background");
      //this.add.image(400, 300, "background_conflict");

      // Countdown Timer
      timedEvent = this.time.addEvent({
        delay: 1000,
        callback: decrementCountdown,
        callbackScope: this,
        loop: true,
      });

      // Game timer
      timedEvent = this.time.addEvent({
        delay: 1000,
        callback: decrementGameTimer,
        callbackScope: this,
        loop: true,
      });

      //Rocket
      rocket = this.physics.add.sprite(400, 592, "rocket");
      rocket.setGravityY(-300);

      //Rocket Platform
      rocketPlatform = this.physics.add.staticGroup();
      rocketPlatform.create(400, 505, "rocket_platform");

      //Door
      door = this.physics.add.staticGroup();
      door.create(100, 500, "door");

      //Red Switch
      redSwitch = this.physics.add.staticGroup();
      redSwitch.create(140, 520, "switch_red");

      //Green Switch
      greenSwitch = this.physics.add.sprite(140, 520, "switch_green");
      greenSwitch.setGravityY(-300);
      greenSwitch.visible = false;

      //Platforms
      platforms = this.physics.add.staticGroup();

      platforms.create(400, 568, "ground").setScale(2).refreshBody();

      platforms.create(700, 375, "ground");
      platforms.create(100, 375, "ground");
      platforms.create(850, 220, "ground");
      platforms.create(-50, 220, "ground");

      //Barriers
      platformBarriers = this.physics.add.staticGroup();
      platformBarriers.create(630, 175, "barrier", null, false, true);
      platformBarriers.create(815, 175, "barrier", null, false, true);
      platformBarriers.create(170, 175, "barrier", null, false, true);
      platformBarriers.create(-15, 175, "barrier", null, false, true);
      platformBarriers.create(320, 330, "barrier", null, false, true);
      platformBarriers.create(-15, 330, "barrier", null, false, true);
      platformBarriers.create(480, 330, "barrier", null, false, true);
      platformBarriers.create(815, 330, "barrier", null, false, true);
      platformBarriers.create(-15, 510, "barrier", null, false, true);
      platformBarriers.create(815, 510, "barrier", null, false, true);
      platformBarriers.create(398, 260, "barrier", null, false, true);

      //Player
      player = this.physics.add.sprite(100, 510, "jepack_dude");

      player.setBounce(0.2);
      player.setCollideWorldBounds(true);

      //Player Animations
      this.anims.create({
        key: "left",
        frames: this.anims.generateFrameNumbers("jepack_dude", {
          start: 0,
          end: 14,
        }),
        frameRate: 25,
        repeat: -1,
      });

      this.anims.create({
        key: "turn_right",
        frames: [{ key: "turn_right", frame: 0 }],
        frameRate: 20,
      });

      this.anims.create({
        key: "turn_left",
        frames: [{ key: "turn_left", frame: 0 }],
        frameRate: 20,
      });

      this.anims.create({
        key: "right",
        frames: this.anims.generateFrameNumbers("jepack_dude", {
          start: 16,
          end: 31,
        }),
        frameRate: 25,
        repeat: -1,
      });

      this.anims.create({
        key: "jump_right",
        frames: this.anims.generateFrameNumbers("jump_right", {
          start: 0,
          end: 0,
        }),
        frameRate: 10,
        repeat: -1,
      });

      this.anims.create({
        key: "jump_left",
        frames: this.anims.generateFrameNumbers("jump_left", {
          start: 0,
          end: 0,
        }),
        frameRate: 10,
        repeat: -1,
      });

      //Hacker
      hackers = this.physics.add.group();

      //TODO: Clean Up Hacker Animations
      this.anims.create({
        key: "hacker_left",
        frames: this.anims.generateFrameNumbers("hacker_left", {
          start: 0,
          end: 9,
        }),
        frameRate: 10,
        repeat: -1,
      });

      this.anims.create({
        key: "hacker_right",
        frames: this.anims.generateFrameNumbers("hacker_right", {
          start: 0,
          end: 9,
        }),
        frameRate: 10,
        repeat: -1,
      });

      //Effects Animations
      this.anims.create({
        key: "flame",
        frames: this.anims.generateFrameNumbers("flame", {
          start: 0,
          end: 6,
        }),
        frameRate: 10,
        repeat: -1,
      });

      this.anims.create({
        key: "portal",
        frames: this.anims.generateFrameNumbers("portal", {
          start: 0,
          end: 15,
        }),
        frameRate: 10,
        repeat: -1,
      });

      
      this.anims.create({
        key: "bomb_sprite",
        frames: this.anims.generateFrameNumbers("bomb_sprite", {
          start: 0,
          end: 7,
        }),
        frameRate: 10,
        repeat: -1,
      });

      //Enable Keyboard Inputs
      cursors = this.input.keyboard.createCursorKeys();

      //Bugs
      bugs = this.physics.add.group({
        key: "bug",
        //Will create 12 bugs total, 1 original and 12 children
        repeat: 11,
        //Placement of generated bugs
        setXY: { x: 12, y: 0, stepX: 70 },
      });

      bugs.children.iterate(function (child) {
        child.setBounceY(Phaser.Math.FloatBetween(0.4, 0.8));
        //Gravity can be overridden on a body from the value set in the config above
        child.setGravityY(400);
      });

      //Bombs
      bombs = this.physics.add.group();

      //FireWall PowerUp
      firewallPowerups = this.physics.add.group();

      //Adds the collision between the objects and the platforms
      this.physics.add.collider(player, platforms);
      this.physics.add.collider(hackers, platforms);
      this.physics.add.collider(hackers, platformBarriers);
      rocketCollider = this.physics.add.collider(
        rocket,
        platformBarriers,
        rocketPreLaunch,
        null,
        this
      );
      this.physics.add.collider(bugs, platforms);
      this.physics.add.collider(bombs, platforms);
      this.physics.add.collider(firewallPowerups, platforms);
      this.physics.add.collider(player, hackers);
      this.physics.add.collider(player, bombs, hitBomb, null, this);

      //Overlaps Events
      this.physics.add.overlap(player, bugs, squashBugs, null, this);
      this.physics.add.overlap(player, redSwitch, launchRocket, null, this);
      this.physics.add.overlap(
        player,
        firewallPowerups,
        enableFirewall,
        null,
        this
      );

      //Bug Count
      bugText = this.add.text(16, 16, "Bugs: 12", {
        fontSize: "20px",
        fill: "#FFFFFF",
      });

      //Round
      roundText = this.add.text(675, 16, "Round: 1", {
        fontSize: "20px",
        fill: "#FFFFFF",
      });

      //End Round One Text
      endRoundOne = this.add.text(60, 75, [
        "You squashed all the bugs!",
        "Unfortunately, the client's internal dev team introduced some new ones.",
      ]);
      endRoundOne.setStyle({
        fontSize: "16px",
        fontFamily: "Courier",
        align: "center",
        backgroundColor: "black",
      });
      endRoundOne.visible = false;

      //End Round Two Text
      endRoundTwo = this.add.text(125, 75, [
        "Who was in charge of site security?",
        "It looks like we may have some intruders in the codebase",
        "trying to drop some malicious code snippets.",
        "Get the firewall configured and don't",
        "touch any of that code they're are dropping in!",
      ]);
      endRoundTwo.setStyle({
        fontSize: "16px",
        fontFamily: "Courier",
        align: "center",
        backgroundColor: "black",
      });
      endRoundTwo.visible = false;

      //End Round Three Text
      endRoundThree = this.add.text(150, 75, [
        "Wasn't this project supposed to go live months ago?",
        "Bad news, a junior dev apparently",
        "resolved some merge conflicts with his eyes closed.",
        "Get in their soldier!",
      ]);
      endRoundThree.setStyle({
        fontSize: "16px",
        fontFamily: "Courier",
        align: "center",
        backgroundColor: "black",
      });
      endRoundThree.visible = false;

      //End Round Four Text
      endRoundFour = this.add.text(90, 75, [
        "Supposedly, this is the final FINAL list of issues from the client.",
        "We'll see.",
      ]);
      endRoundFour.setStyle({
        fontSize: "16px",
        fontFamily: "Courier",
        align: "center",
        backgroundColor: "black",
      });
      endRoundFour.visible = false;

      //End Round Five Text
      endRoundFive = this.add.text(50, 75, [
        "You've finally gotten through the list of bugs,",
        "secured the site, and completed your ToDo's.",
        "The site is finally ready to launch!",
        "Hit the green switch to go live before the client asks for a new feature!"
      ]);
      endRoundFive.setStyle({
        fontSize: "16px",
        fontFamily: "Courier",
        align: "center",
        backgroundColor: "black",
      });
      endRoundFive.visible = false;

      //Timer Text
      intermissionTimerText = this.add.text(375, 175, [countDown]);
      intermissionTimerText.setStyle({
        fontSize: "64px",
        fontFamily: "Courier",
        align: "center",
      });
      intermissionTimerText.visible = false;

      //Game Timer Text
      gameTimerText = this.add.text(375, 16, [formatTime(gameTimer)]);
      gameTimerText.setStyle({
        fontSize: "20px",
        fontFamily: "Courier",
        align: "center",
      });
      gameTimerText.visible = true;
    }

    function update() {
      if (cursors.left.isDown) {
        facingRight = false;
        player.setVelocityX(-160);

        if (player.body.touching.down) {
          player.anims.play("left", true);
        } else {
          player.anims.play("jump_left", true);
        }
      } else if (cursors.right.isDown) {
        facingRight = true;
        player.setVelocityX(160);

        if (player.body.touching.down) {
          player.anims.play("right", true);
        } else {
          player.anims.play("jump_right", true);
        }
      } else {
        if (facingRight) {
          player.anims.play("turn_right");
        } else {
          player.anims.play("turn_left");
        }
        player.setVelocityX(0);
      }

      //Jump
      //Check to see if Up Key is depressed AND if player body is touching solid ground
      if (cursors.up.isDown) {
        if (facingRight) {
          player.anims.play("jump_right", true);
        } else {
          player.anims.play("jump_left", true);
        }

        if (player.body.touching.down) {
          player.setVelocityY(-330);
        }
      }

      //Hacker Movements
      hackers.children.iterate(function (child) {
        if (child.body.touching.right) {
          console.log("hacker touch right");
          child.setVelocityX(-80);
          child.anims.play("hacker_left", true);
        }

        if (child.body.touching.left) {
          console.log("hacker touch left");
          child.setVelocityX(80);
          child.anims.play("hacker_right", true);
        }
      });

      //Drop Hacker Bombs
      if (hackers.countActive(true) > 0) {
        var GetAll = Phaser.Utils.Array.GetAll;
        var GetRandom = Phaser.Utils.Array.GetRandom;

        var hacker = GetRandom(GetAll(hackers.getChildren(), "active", true));

        var x = hacker.x;
        var y = hacker.y;

        if (
          lastBombRelease - gameTimer > 5 &&
          bombCount <= 4 &&
          allowBombs &&
          !firewallUp
        ) {
          var bomb = bombs.create(x, y, "bomb");
          //bomb.anims.play("bomb_sprite", true)
          bomb.setBounce(1);
          bomb.setCollideWorldBounds(true);
          bomb.setVelocity(Phaser.Math.Between(-200, 200), 80);
          lastBombRelease = gameTimer;
          bombCount++;
        }
      }
    }

    function squashBugs(player, bug) {
      console.log("Squashed Bug");

      bug.disableBody(true, true);

      bugCount -= 1;
      bugText.setText("Bugs: " + bugCount);

      if (bugs.countActive(true) === 0) {
        switch (round) {
          case 1:
            roundComplete = true;
            startBouncingBugsRound(player, bug);
            break;

          case 2:
            startHackerRound(player, bug);
            break;

          //This will never be hit because there are no bugs in the hacker round
          // case 3:
          //   startFlyingBugsRound(player, bug);
          //   break;

          case 4:
            startFinalRound(player, bug);
            break;

          case 5:
            rocket.setGravityY(-400);
            greenSwitch.visible = true;
            endRoundFive.visible = true;
            break;
        }

        // var x = (player.x < 400) ? Phaser.Math.Between(400, 800) : Phaser.Math.Between(0, 400);

        // var bomb = bombs.create(x, 16, 'bomb');
        // bomb.setBounce(1);
        // bomb.setCollideWorldBounds(true);
        // bomb.setVelocity(Phaser.Math.Between(-200, 200), 20);
      }
    }

    function startBouncingBugsRound(player, bug) {
      console.log("Start Round 2");

      intermissionTimer();

      gameTimerText.visible = false;
      bugText.visible = false;
      roundText.visible = false;

      endRoundOne.visible = true;

      beginNext();

      function beginNext() {
        setTimeout(function () {
          endRoundOne.visible = false;
          bugCount = 12;
          round = 2;
          roundText.setText("Round: " + round);
          gameTimerText.visible = true;
          bugText.visible = true;
          roundText.visible = true;

          bugs.children.iterate(function (child) {
            child.enableBody(true, child.x, 0, true, true);
            child.setBounceY(Phaser.Math.FloatBetween(0.9, 1));
            child.setGravityY(0);
          });
        }, 10500);
      }
    }

    function startHackerRound(player, bug) {
      console.log("Start Round 3");

      intermissionTimer();

      gameTimerText.visible = false;
      bugText.visible = false;
      roundText.visible = false;

      endRoundTwo.visible = true;

      beginNext();

      function beginNext() {
        setTimeout(function () {
          endRoundTwo.visible = false;
          bugText.setText("Warning: Intruder Detected");
          bugCount = 12;
          round = 3;
          roundText.setText("Round: " + round);

          gameTimerText.visible = true;
          roundText.visible = true;

          spawnHacker();
        }, 10500);
      }
    }

    function startFlyingBugsRound(player, bug) {
      console.log("Start Round 4");
      bugText.setText("Bugs: " + bugCount);

      intermissionTimer();

      gameTimerText.visible = false;
      bugText.visible = false;
      roundText.visible = false;

      endRoundThree.visible = true;

      beginNext();

      function beginNext() {
        setTimeout(function () {
          endRoundThree.visible = false;
          bugCount = 12;
          round = 4;
          roundText.setText("Round: " + round);

          gameTimerText.visible = true;
          bugText.visible = true;
          roundText.visible = true;

          bugs.children.iterate(function (child) {
            child.enableBody(true, child.x, 0, true, true);
            child.setBounce(1);
            child.setCollideWorldBounds(true);
            child.setVelocity(Phaser.Math.Between(-200, 200), 20);
            child.setGravityY(0);
          });
        }, 10500);
      }
    }

    function startFinalRound(player, bug) {
      console.log("Start Round 5");

      intermissionTimer();

      gameTimerText.visible = false;
      bugText.visible = false;
      roundText.visible = false;

      endRoundFour.visible = true;

      beginNext();

      function beginNext() {
        setTimeout(function () {
          endRoundFour.visible = false;
          bugCount = 12;
          round = 5;
          roundText.setText("Round: " + round);

          gameTimerText.visible = true;
          bugText.visible = true;
          roundText.visible = true;

          //TODO: New Enemy Patterns & Add Hackers
          bugs.children.iterate(function (child) {
            child.enableBody(true, child.x, 0, true, true);
            child.setBounce(1);
            child.setCollideWorldBounds(true);
            child.setVelocity(Phaser.Math.Between(-200, 200), 20);
            child.setGravityY(0);
          });
        }, 10500);
      }
    }

    function intermissionTimer(player, bug) {
      console.log("Intermission Timer Started");
      countDown = 11;
    }

    function decrementCountdown() {
      countDown -= 1; // One second
      intermissionTimerText.setText(countDown);

      if (countDown <= 3 && roundComplete) {
        intermissionTimerText.visible = true;
      }

      if (countDown <= 0) {
        intermissionTimerText.visible = false;
      }
    }

    function decrementGameTimer() {
      if (gameTimerText.visible === true) {
        gameTimer -= 1; // One second
        gameTimerText.setText(formatTime(gameTimer));
      }
    }

    function spawnHacker() {
      var coordinates = [
        [80, 150],
        [640, 310],
        [240, 310],
        [150, 510],
        [700, 175],
      ];

      for (var i = 0; i < 3; i++) {
        var item = Phaser.Utils.Array.RemoveRandomElement(coordinates);
        console.log(item);

        var hacker = hackers.create(item[0], item[1], "dude");
        hacker.setBounce(0.2);
        hacker.setCollideWorldBounds(true);

        hacker.anims.play("portal", true);
      }

      hackers.children.iterate(function (child) {
        var right = Math.random() >= 0.5;

        setTimeout(function () {
          if (right) {
            child.setVelocityX(80);
            child.anims.play("hacker_right", true);

            if (!allowBombs) {
              allowBombs = true;
            }
          } else {
            child.setVelocityX(-80);
            child.anims.play("hacker_left", true);

            if (!allowBombs) {
              allowBombs = true;
            }
          }
        }, 1500);
      });

      dropPowerUp();

      function dropPowerUp(x, y) {
        setTimeout(function () {
          var powerUp = firewallPowerups.create(
            Phaser.Math.Between(0, 800),
            0,
            "firewallPowerup"
          );
          powerUp.setBounce(1);
          powerUp.setGravityY(-200);
          powerUp.setCollideWorldBounds(true);
          powerUp.setVelocity(Phaser.Math.Between(-200, 200), 20);
        }, 2000);
      }
    }

    function hitBomb(player, bomb) {
      console.log("Hit Bomb");

      this.physics.pause();

      player.setTint(0xff0000);

      player.anims.play("turn");

      gameOver = true;
    }

    function enableFirewall(player, star) {
      firewallUp = true;
      allowBombs = false;
      star.disableBody(true, true);

      hackers.children.iterate(function (child) {
        child.setVelocityX(0);
        child.anims.play("flame", true);

        setTimeout(function () {
          child.disableBody(true, true);
          startFlyingBugsRound();
        }, 750);
      });

      bombs.children.iterate(function (child) {
        child.setVelocityX(0);
        child.anims.play("flame", true);

        setTimeout(function () {
          child.disableBody(true, true);
        }, 750);
      });
    }

    function launchRocket(player, redSwitch) {
      console.log("Switch Hit. Bug Count: " + bugCount);
      if (bugCount <= 0 && round === 5 && !launched && preLaunchComplete) {

        endRoundFive.visible = false;
        // countDown = 3;

        setTimeout(function () {
          //this.cameras.main.shake(500);
          rocket.setVelocityY(-600);
          launched = true;
        }, 3000);
      }
    }

    function rocketPreLaunch(rocket, platformBarriers) {
      console.log("Pre-Launch started");
      rocket.setGravityY(-300);

      this.physics.world.removeCollider(rocketCollider);

      preLaunchComplete = true;
    }

    function formatTime(seconds) {
      // Minutes
      var minutes = Math.floor(seconds / 60);
      // Seconds
      var partInSeconds = seconds % 60;
      // Adds left zeros to seconds
      partInSeconds = partInSeconds.toString().padStart(2, "0");
      // Returns formated time
      return `${minutes}:${partInSeconds}`;
    }
  </script>
</body>

</html>